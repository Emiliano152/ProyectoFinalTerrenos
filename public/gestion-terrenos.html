<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Terrenos | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="/dashboard.html">‚¨Ö Volver al Dashboard</a>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üöú Inventario de Terrenos</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrear">
            + Nuevo Terreno
        </button>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>C√≥digo</th>
                            <th>Precio</th>
                            <th>Estatus</th>
                            <th>Activo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTerrenos"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrear" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Terreno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrear">
                    <input type="text" class="form-control mb-2" id="newCode" placeholder="C√≥digo (ej. L-10)" required>
                    <input type="number" class="form-control mb-2" id="newSize" placeholder="Tama√±o m¬≤" required>
                    <input type="number" class="form-control mb-2" id="newPrice" placeholder="Precio" required>
                    <textarea class="form-control mb-2" id="newGeo" placeholder='Pega aqu√≠ el GeoJSON {"type":...}' rows="3" required></textarea>
                    <button type="submit" class="btn btn-success w-100">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar / Cambio Manual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <input type="hidden" id="editId">
                    <div class="mb-2">
                        <label>C√≥digo</label>
                        <input type="text" class="form-control" id="editCode">
                    </div>
                    <div class="mb-2">
                        <label>Precio</label>
                        <input type="number" class="form-control" id="editPrice">
                    </div>
                    <div class="mb-2">
                        <label>Estatus (Cambio Manual)</label>
                        <select class="form-select" id="editStatus">
                            <option value="Disponible">Disponible</option>
                            <option value="Apartado">Apartado</option>
                            <option value="Vendido">Vendido</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editActive">
                        <label class="form-check-label">Terreno Activo (Visible en mapa)</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Actualizar Datos</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('token');
    
    // 1. CARGAR TABLA
    async function cargarTabla() {
        const res = await fetch('/api/admin/lands', { headers: { 'Authorization': `Bearer ${token}` }});
        const data = await res.json();
        
        const tbody = document.getElementById('tablaTerrenos');
        tbody.innerHTML = '';
        
        data.forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td>${t.LandId}</td>
                    <td>${t.Code}</td>
                    <td>$${t.Price}</td>
                    <td><span class="badge ${getColorBadge(t.Status)}">${t.Status}</span></td>
                    <td>${t.IsActive ? '‚úÖ' : '‚ùå'}</td>
                    <td>
                        <button onclick='abrirEditar(${JSON.stringify(t)})' class="btn btn-sm btn-warning">‚úèÔ∏è Editar</button>
                    </td>
                </tr>
            `;
        });
    }

    function getColorBadge(status) {
        if(status === 'Disponible') return 'bg-success';
        if(status === 'Apartado') return 'bg-warning text-dark';
        return 'bg-danger';
    }

    // 2. CREAR TERRENO
    document.getElementById('formCrear').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
            code: document.getElementById('newCode').value,
            size: document.getElementById('newSize').value,
            price: document.getElementById('newPrice').value,
            geoJsonData: document.getElementById('newGeo').value
        };

        const res = await fetch('/api/admin/lands', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
        });

        if(res.ok) { alert('Creado!'); location.reload(); }
        else alert('Error al crear');
    });

    // 3. ABRIR MODAL EDITAR
    window.abrirEditar = (terreno) => {
        document.getElementById('editId').value = terreno.LandId;
        document.getElementById('editCode').value = terreno.Code;
        document.getElementById('editPrice').value = terreno.Price;
        document.getElementById('editStatus').value = terreno.Status;
        document.getElementById('editActive').checked = terreno.IsActive;
        
        new bootstrap.Modal(document.getElementById('modalEditar')).show();
    }

    // 4. GUARDAR EDICI√ìN
    document.getElementById('formEditar').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const body = {
            code: document.getElementById('editCode').value,
            size: 0, // No lo puse en el form para ahorrar espacio, pero se podr√≠a
            price: document.getElementById('editPrice').value,
            status: document.getElementById('editStatus').value,
            isActive: document.getElementById('editActive').checked ? 1 : 0
        };

        const res = await fetch(`/api/admin/lands/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(body)
        });

        if(res.ok) { alert('Actualizado!'); location.reload(); }
        else alert('Error al actualizar');
    });

    cargarTabla();
</script>
</body>
</html>