<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Vista Azure</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-counter {
            border-left: 5px solid;
            transition: transform 0.2s;
        }
        .card-counter:hover { transform: translateY(-5px); }
        .border-blue { border-color: #36A2EB; }
        .border-yellow { border-color: #FFCE56; }
        .border-red { border-color: #FF6384; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 shadow">
        <a class="navbar-brand fw-bold" href="#">üè¢ Admin Panel</a>
        <div class="ms-auto d-flex gap-2">
            <a href="/gestion-terrenos.html" class="btn btn-warning btn-sm fw-bold">‚öôÔ∏è Gestionar Terrenos</a>
            <button onclick="logout()" class="btn btn-outline-light btn-sm">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <div class="container mt-5">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Resumen del Desarrollo</h2>
            <button onclick="cargarTodo()" class="btn btn-primary btn-sm">üîÑ Actualizar Datos</button>
        </div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-white fw-bold">Estado del Inventario</div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div style="width: 100%; max-width: 300px;">
                            <canvas id="graficaTerrenos"></canvas>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-center text-muted small">
                        Total de terrenos visualizados en tiempo real
                    </div>
                </div>
            </div>

            <div class="col-md-8 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                        <span>üìù Apartados Pendientes de Pago</span>
                        <span class="badge bg-danger" id="badgePendientes">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Lote</th>
                                        <th>Cliente / Email</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th class="text-end">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPendientes">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        // 1. PROTECCI√ìN DE RUTA
        if (!token || role !== 'admin') {
            alert("Acceso denegado.");
            window.location.href = '/index.html';
        }

        // 2. CARGAR TODO AL INICIAR
        async function cargarTodo() {
            await cargarGrafica();
            await cargarTablaConfirmaciones();
        }

        // --- A. L√ìGICA DE LA GR√ÅFICA (ACTUALIZADA) ---
        let miChartObj = null;

        async function cargarGrafica() {
            try {
                // 1. Llamamos al nuevo endpoint
                const res = await fetch('/api/dashboard/lands-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // 2. Preparamos los datos manualmente para Chart.js
                // El API devuelve: { disponible: 15, apartado: 8, vendido: 12, total: 35 }
                
                const labels = ['Disponible', 'Apartado', 'Vendido'];
                const counts = [data.disponible, data.apartado, data.vendido];
                const colors = ['#2ecc71', '#f1c40f', '#e74c3c']; // Verde, Amarillo, Rojo

                // Actualizamos el contador total visual
                // (Opcional: si quieres mostrar el total en alg√∫n lado)
                console.log("Total de terrenos:", data.total);

                const ctx = document.getElementById('graficaTerrenos').getContext('2d');
                
                if (miChartObj) miChartObj.destroy();

                miChartObj = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: colors,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

            } catch (error) {
                console.error("Error gr√°fica:", error);
            }
        }

        // --- B. L√ìGICA DE LA TABLA ---
        async function cargarTablaConfirmaciones() {
            try {
                const res = await fetch('/api/admin/reservas-pendientes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const reservas = await res.json();
                
                document.getElementById('badgePendientes').innerText = reservas.length;
                const tbody = document.getElementById('tablaPendientes');
                tbody.innerHTML = '';

                if (reservas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No hay confirmaciones pendientes</td></tr>';
                    return;
                }

                reservas.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold text-primary">${r.Code}</td>
                            <td>
                                ${r.FullName}<br>
                                <small class="text-muted">${r.Email}</small>
                            </td>
                            <td>${new Date(r.CreatedAt).toLocaleDateString()}</td>
                            <td class="fw-bold text-success">$${r.Price.toLocaleString()}</td>
                            <td class="text-end">
                                <button onclick="confirmarVenta(${r.ReservationId}, ${r.LandId})" 
                                    class="btn btn-success btn-sm shadow-sm">
                                    ‚úÖ Aprobar Venta
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error("Error tabla:", error);
            }
        }

        // --- C. ACCI√ìN DE CONFIRMAR ---
        async function confirmarVenta(resId, landId) {
            if (!confirm("¬øConfirmas que recibiste el pago? El terreno pasar√° a VENDIDO.")) return;

            try {
                const res = await fetch('/api/admin/confirmar-venta', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ reservationId: resId, landId: landId })
                });

                if (res.ok) {
                    alert("¬°Venta registrada con √©xito!");
                    cargarTodo(); // Recargar gr√°fica y tabla
                } else {
                    alert("Error al confirmar.");
                }
            } catch (error) {
                console.error(error);
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        // Inicializar
        cargarTodo();
    </script>
</body>
</html>